<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lubentine's</title>
    <link rel="icon" type="image/png" href="assets/fav.png">
    <link href="https://fonts.googleapis.com/css2?family=Comic+Relief&family=Dela+Gothic+One&family=Roboto:wght@400;500;700;800&family=Zen+Antique+Soft&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        :root {
            --primary: #ff4d6d;
            --primary-hover: #e63956;
            --secondary: #ffb3c1;
            --dark: #590d22;
            --glass: rgba(255, 255, 255, 0.96);
            --card-w: 400;
            --card-h: 500;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(160deg, #ffccd5 0%, #ffb3c1 40%, #ff8fa3 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            padding-bottom: 40px;
        }

        /* Floating hearts background */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image:
                radial-gradient(circle at 15% 20%, rgba(255,77,109,0.12) 0%, transparent 50%),
                radial-gradient(circle at 85% 70%, rgba(89,13,34,0.08) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(255,179,193,0.15) 0%, transparent 60%);
            pointer-events: none;
            z-index: 0;
        }

        /* â”€â”€â”€ Header â”€â”€â”€ */
        .app-header {
            text-align: center;
            padding: 30px 20px 10px;
            z-index: 5;
            position: relative;
        }
        .app-header h1 {
            font-family: 'Roboto', sans-serif;
            font-size: 2rem;
            color: var(--dark);
            text-shadow: 0 2px 10px rgba(255,77,109,0.2);
        }
        .app-header .logo {
            max-width: 260px;
            width: 70%;
            height: auto;
        }
        .app-header p {
            color: #800f2f;
            font-size: 0.85rem;
            margin-top: 4px;
            opacity: 0.7;
        }

        /* â”€â”€â”€ Step indicator â”€â”€â”€ */
        .step-indicator {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 15px 0 5px;
            z-index: 5;
            position: relative;
        }
        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(89,13,34,0.15);
            transition: all 0.4s ease;
        }
        .step-dot.active {
            background: var(--primary);
            width: 28px;
            border-radius: 5px;
        }
        .step-dot.done {
            background: var(--dark);
        }

        /* â”€â”€â”€ Preview Area â”€â”€â”€ */
        .preview-area {
            display: none;
            justify-content: center;
            padding: 15px 0;
            z-index: 10;
            position: relative;
            width: 100%;
        }
        .preview-area.visible { display: flex; }

        .canvas-wrapper {
            box-shadow: 0 20px 60px rgba(89, 13, 34, 0.25), 0 0 0 1px rgba(255,255,255,0.3);
            border-radius: 18px;
            overflow: hidden;
            background: white;
            line-height: 0;
            transition: transform 0.4s ease, margin 0.4s ease;
        }

        /* â”€â”€â”€ Controls Panel â”€â”€â”€ */
        .main-app {
            width: 92%;
            max-width: 480px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 28px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(89,13,34,0.1), 0 0 0 1px rgba(255,255,255,0.6);
            margin: 15px 0;
            z-index: 20;
            position: relative;
        }

        .step-panel {
            display: none;
        }
        .step-panel.active {
            display: block;
            animation: slideUp 0.4s cubic-bezier(0.22, 0.61, 0.36, 1);
        }

        @keyframes slideUp {
            from { transform: translateY(15px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .step-title {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--dark);
            margin-bottom: 16px;
        }

        /* â”€â”€â”€ Character Grid â”€â”€â”€ */
        .char-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .char-box {
            aspect-ratio: 1;
            border-radius: 16px;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            border: none;
            transition: all 0.25s ease;
            overflow: hidden;
        }
        .char-box:hover { transform: translateY(-2px); }
        .char-box.selected {
            outline: 3px solid var(--primary);
            outline-offset: 2px;
            transform: scale(1.04);
            box-shadow: 0 0 0 3px rgba(255,77,109,0.3), 0 8px 25px rgba(255,77,109,0.2);
        }

        /* â”€â”€â”€ Scroll Row â”€â”€â”€ */
        .scroll-row {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 8px 2px;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        .scroll-row::-webkit-scrollbar { display: none; }

        .section-label {
            font-size: 0.8rem;
            font-weight: 700;
            color: #a4133c;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 14px 0 6px;
        }

        /* â”€â”€â”€ Option Items (bg/decor) â”€â”€â”€ */
        .opt-item {
            flex: 0 0 68px;
            height: 68px;
            border-radius: 14px;
            border: 2.5px solid #f0f0f0;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            transition: all 0.2s ease;
            position: relative;
        }
        .opt-item:hover {
            border-color: var(--secondary);
            transform: translateY(-2px);
        }
        .opt-item.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(255,77,109,0.25);
        }

        .opt-item-decor {
            flex: 0 0 62px;
            height: 62px;
            border-radius: 14px;
            border: 2.5px solid #f0f0f0;
            cursor: pointer;
            background-size: 80%;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #fff;
            transition: all 0.2s ease;
        }
        .opt-item-decor:hover {
            border-color: var(--secondary);
            transform: scale(1.05);
        }

        .decor-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .decor-grid .opt-item-decor {
            flex: none;
            width: 100%;
            height: 0;
            padding-bottom: 65%;
            position: relative;
            background-size: 60%;
            border-radius: 10px;
        }
        .decor-grid .opt-item-decor::after {
            content: '';
            position: absolute;
            inset: 0;
        }

        /* â”€â”€â”€ Text Area â”€â”€â”€ */
        .wish-textarea {
            width: 100%;
            min-height: 80px;
            max-height: 140px;
            padding: 14px 16px;
            border-radius: 16px;
            border: 2px solid #f5d0d6;
            font-family: 'Roboto', sans-serif;
            font-size: 0.95rem;
            color: var(--dark);
            outline: none;
            resize: none;
            background: #fff;
            transition: border-color 0.2s;
        }
        .wish-textarea:focus { border-color: var(--primary); }

        /* â”€â”€â”€ Font selector â”€â”€â”€ */
        .font-options {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .font-btn {
            flex: 1;
            padding: 10px 8px;
            border-radius: 12px;
            border: 2px solid #f0f0f0;
            background: #fff;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--dark);
            transition: all 0.2s;
            text-align: center;
        }
        .font-btn:hover { border-color: var(--secondary); }
        .font-btn.selected { border-color: var(--primary); background: #fff5f7; }

        /* â”€â”€â”€ Color picker row â”€â”€â”€ */
        .color-options {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .color-dot {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 3px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s;
        }
        .color-dot:hover { transform: scale(1.1); }
        .color-dot.selected { border-color: var(--dark); box-shadow: 0 0 0 2px rgba(89,13,34,0.2); }

        /* â”€â”€â”€ Buttons â”€â”€â”€ */
        .btn-next {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 16px;
            font-weight: 800;
            font-size: 1rem;
            font-family: 'Roboto', sans-serif;
            margin-top: 16px;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.3px;
        }
        .btn-next:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn-next:active { transform: translateY(0); }
        .btn-next:disabled {
            background: #ddd;
            color: #aaa;
            cursor: not-allowed;
            transform: none;
        }

        .btn-back {
            width: 100%;
            background: transparent;
            color: #a4133c;
            border: 2px solid #f5d0d6;
            padding: 12px;
            border-radius: 16px;
            font-weight: 700;
            font-size: 0.9rem;
            font-family: 'Roboto', sans-serif;
            margin-top: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-back:hover { border-color: var(--primary); }

        .btn-finish {
            width: 100%;
            background: linear-gradient(135deg, #c9184a, #ff4d6d);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 16px;
            font-weight: 800;
            font-size: 1.05rem;
            font-family: 'Roboto', sans-serif;
            margin-top: 16px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(201,24,74,0.3);
        }
        .btn-finish:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(201,24,74,0.4); }

        /* â”€â”€â”€ Final Actions â”€â”€â”€ */
        #finalActions {
            display: none;
            gap: 18px;
            justify-content: center;
            margin-top: 20px;
            z-index: 20;
            position: relative;
        }

        .action-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: white;
            box-shadow: 0 6px 20px rgba(89,13,34,0.12);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            transition: all 0.2s;
        }
        .action-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(89,13,34,0.18); }

        /* â”€â”€â”€ Responsive â”€â”€â”€ */
        @media (max-width: 520px) {
            .canvas-wrapper {
                transform: scale(0.82);
                transform-origin: top center;
                margin-bottom: -36px;
            }
            .main-app { padding: 18px; }
            .app-header .logo { max-width: 200px; }
            .step-title { font-size: 1.05rem; }
            .decor-grid { gap: 6px; }
            .decor-grid .opt-item-decor { padding-bottom: 55%; background-size: 55%; }
        }

        @media (max-width: 400px) {
            .canvas-wrapper {
                transform: scale(0.72);
                margin-bottom: -55px;
            }
            .char-grid { gap: 6px; }
            .opt-item { flex: 0 0 56px; height: 56px; }
            .main-app { padding: 16px; border-radius: 22px; }
            .btn-next, .btn-finish { padding: 14px; font-size: 0.95rem; }
            .btn-back { padding: 10px; font-size: 0.85rem; }
            .font-options { gap: 5px; }
            .font-btn { padding: 8px 5px; font-size: 0.75rem; }
            .decor-grid .opt-item-decor { padding-bottom: 50%; }
        }

        @media (max-width: 340px) {
            .canvas-wrapper {
                transform: scale(0.62);
                margin-bottom: -80px;
            }
            .app-header .logo { max-width: 160px; }
            .app-header p { font-size: 0.75rem; }
        }

        /* Tall phones: give preview more room */
        @media (max-height: 700px) and (max-width: 520px) {
            .canvas-wrapper {
                transform: scale(0.65);
                transform-origin: top center;
                margin-bottom: -70px;
            }
            .app-header { padding: 15px 20px 5px; }
        }

        /* â”€â”€â”€ Utility â”€â”€â”€ */
        .fade-in { animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <header class="app-header">
        <img src="assets/logo.png" alt="Erotilo Maker" class="logo">
        <p>Î¦Î¤Î™Î‘ÎÎ• Î¤Î— Î’Î‘Î›Î•ÎÎ¤Î™ÎÎŸÎšÎ‘Î¡Î¤Î‘ Î£ÎŸÎ¥</p>
    </header>

    <div class="step-indicator" id="stepIndicator">
        <div class="step-dot active" data-step="1"></div>
        <div class="step-dot" data-step="2"></div>
        <div class="step-dot" data-step="3"></div>
        <div class="step-dot" data-step="4"></div>
    </div>

    <div class="preview-area" id="previewContainer">
        <div class="canvas-wrapper" id="canvasWrapper">
            <canvas id="cardCanvas" width="400" height="500"></canvas>
        </div>
    </div>

    <div class="main-app" id="controlsPanel">

        <!-- STEP 1: Character Selection -->
        <div class="step-panel active" id="step1">
            <div class="step-title">Î¤Î¹ Ï„ÏÏ€Î¿Ï‚ ÎµÏÏ‰Ï„ÏÎ»Î¿Ï… ÎµÎ¯ÏƒÎ±Î¹;</div>
            <div class="char-grid" id="charGrid"></div>
            <button class="btn-next" id="toStep2" disabled onclick="goToStep(2)">Î£Î¥ÎÎ•Î§Î•Î™Î‘</button>
        </div>

        <!-- STEP 2: Background Selection -->
        <div class="step-panel" id="step2">
            <div class="step-title">Î”Î¹Î¬Î»ÎµÎ¾Îµ ÏƒÎºÎ·Î½Î¹ÎºÏŒ</div>
            <div class="scroll-row" id="bgOptions"></div>
            <button class="btn-next" onclick="goToStep(3)">Î“Î¡Î‘Î¨Î• Î•Î¥Î§Î—</button>
            <button class="btn-back" onclick="goToStep(1)">â† Î Î™Î£Î©</button>
        </div>

        <!-- STEP 3: Wish Text -->
        <div class="step-panel" id="step3">
            <div class="step-title">Î¤Î¹ Î¸Î± Ï„Î¿Ï…/Ï„Î·Ï‚ Ï€ÎµÎ¹Ï‚;</div>
            <textarea class="wish-textarea" id="wishInput" oninput="updateText()" placeholder="Î“ÏÎ¬ÏˆÎµ ÎµÎ´Ï Ï„Î·Î½ ÎµÏ…Ï‡Î® ÏƒÎ¿Ï…..."></textarea>
            <div class="section-label">Î“ÏÎ±Î¼Î¼Î±Ï„Î¿ÏƒÎµÎ¹ÏÎ¬</div>
            <div class="font-options" id="fontOptions">
                <button class="font-btn selected" style="font-family:'Roboto',sans-serif;font-weight:500" onclick="setFont('Roboto', this)">Roboto</button>
                <button class="font-btn" style="font-family:'Comic Relief',cursive" onclick="setFont('Comic Relief', this)">Comic</button>
                <button class="font-btn" style="font-family:'Zen Antique Soft',serif" onclick="setFont('Zen Antique Soft', this)">Zen</button>
                <button class="font-btn" style="font-family:'Dela Gothic One',sans-serif" onclick="setFont('Dela Gothic One', this)">Gothic</button>
            </div>
            <div class="section-label">Î§ÏÏÎ¼Î± ÎºÎµÎ¹Î¼Î­Î½Î¿Ï…</div>
            <div class="color-options" id="textColorOptions">
                <div class="color-dot selected" style="background:#fff" onclick="setTextColor('#ffffff', this)"></div>
                <div class="color-dot" style="background:#000" onclick="setTextColor('#000000', this)"></div>
                <div class="color-dot" style="background:#ff4d6d" onclick="setTextColor('#ff4d6d', this)"></div>
            </div>
            <button class="btn-next" onclick="goToStep(4)">Î”Î™Î‘ÎšÎŸÎ£ÎœÎ—Î£Î—</button>
            <button class="btn-back" onclick="goToStep(2)">â† Î Î™Î£Î©</button>
            <div style="text-align:center; margin-top:10px;">
                <a href="#" onclick="resetTextPosition(); return false;" style="font-size:0.78rem; color:#a4133c; text-decoration:underline; opacity:0.7;">Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ Î¸Î­ÏƒÎ·Ï‚ ÎºÎµÎ¹Î¼Î­Î½Î¿Ï…</a>
            </div>
        </div>

        <!-- STEP 4: Decorations -->
        <div class="step-panel" id="step4">
            <div class="step-title">Î’Î¬Î»Îµ Ï„Î¿ ÎºÎ¬Ï„Î¹ Ï€Î±ÏÎ±Ï€Î¬Î½Ï‰</div>
            <div class="decor-grid" id="decorOptions"></div>
            <button class="btn-finish" onclick="finalize()">ÎœÎŸÎ›Î™Î£ Î¤Î•Î›Î•Î™Î©Î£Î‘ ğŸ’¦</button>
            <button class="btn-back" onclick="goToStep(3)">â† Î Î™Î£Î©</button>
        </div>
    </div>

    <div id="finalActions">
        <button class="action-btn" onclick="location.reload()" title="ÎÎ±Î½Î¬ Î±Ï€ÏŒ Ï„Î·Î½ Î±ÏÏ‡Î®">ğŸ”„</button>
        <button class="action-btn" onclick="shareCard()" title="ÎšÎ¿Î¹Î½Î¿Ï€Î¿Î¯Î·ÏƒÎ·">ğŸ”—</button>
        <button class="action-btn" onclick="downloadCard()" title="Î›Î®ÏˆÎ·">ğŸ’¾</button>
    </div>

<script>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DATA
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    const characters = [
        { id: 'bezos',        img: 'bezos.png',        wish: 'Î¤Î¿Î½ ÎœÏ€Î­Î¶Î¿ Î³Î¹Î± ÏƒÎ­Î½Î±.',                                                       bg: 'bezos_bg.png' },
        { id: 'nikolouli',    img: 'nikolouli.png',    wish: 'Î”Î¹Ï€Î»Î¬ Ï†Î¹Î»Î¬ÎºÎ¹Î±.',                                                             bg: 'nikolouli_bg.png' },
        { id: 'gio_kay',      img: 'gio_kay.png',      wish: "Don't do dis, do me.",                                                       bg: 'gio_kay_bg.png' },
        { id: 'vromopappous', img: 'vromopappous.png',  wish: 'Î§ÏÏŒÎ½Î¹Î± Ï€Î¿Î»Î»Î¬ Î²ÏÏ‰Î¼ÏŒÏ€Î±Ï€Ï€Î¿Ï….',                                                  bg: 'vromopappous_bg.png' },
        { id: 'ligdas',       img: 'ligdas.png',       wish: 'Î˜Î­Î»Ï‰ Î½Î± ÏƒÎµ Î¾ÎµÎ´Î¹Ï€Î»ÏÏƒÏ‰ Î±Î½Î±Î»ÏŒÎ³Ï‰Ï‚ ÎºÎ±Î¹ Ï„Î¿Î¹Î¿Ï…Ï„Î¿Ï„ÏÏŒÏ€Ï‰Ï‚.',                            bg: 'ligdas_bg.png' },
        { id: 'katakouzinos', img: 'katakouzinos.png', wish: 'Î‘Ï…Ï„ÏŒ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Ï„Î¿ ÏŒÏÎ³Î±Î½ÏŒ Î¼Î¿Ï…, Î±Ï…Ï„ÏŒ Ï„Î¿ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Ï Ï‰Ï‚ Ï€ÏÎ¿Ï†Ï…Î»Î±ÎºÏ„Î¹ÎºÏŒ.',          bg: 'katakouzinos_bg.png' },
        { id: 'bad_bunny',    img: 'bad_bunny.png',    wish: 'Î˜Î­Î»Ï‰ Î½Î± Î³Î¯Î½ÎµÎ¹Ï‚ Î· ÎºÎ±ÎºÎ¹Î¬ ÎºÎ¿Ï…Î½Î­Î»Î± Î¼Î¿Ï….',                                        bg: 'bad_bunny_bg.png' },
        { id: 'bartzokas',    img: 'bartzokas.png',    wish: 'Î‘ÎºÎ¿ÏÏ‚ \u0336Î²\u0336Î³Î±Î¶Î­Î»Î±;',                                                  bg: 'bartzokas_bg.png' },
        { id: 'karamitrou',   img: 'karamitrou.png',   wish: 'Î˜Î­Î»Ï‰ Î½Î± Î³Î¯Î½Ï‰ Î¼Î­Î»Î¹ÏƒÏƒÎ± ÏƒÏ„Î¿ Î¼ÎµÎ»Î¯ÏƒÏƒÎ¹ ÏƒÎ¿Ï….',                                      bg: 'karamitrou_bg.png' }
    ];

    const solidBGs = [
        { t: 'col', v: 'rgb(0, 0, 0)' },
        { t: 'col', v: 'rgb(225, 118, 132)' },
        { t: 'col', v: 'rgb(225, 47, 129)' },
        { t: 'col', v: 'rgb(240, 150, 210)' }
    ];

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STATE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    let canvas;
    let textObj = null;
    let charImgObj = null;
    let selectedChar = null;
    let currentStep = 1;

    const CANVAS_W = 400;
    const CANVAS_H = 500;
    const TEXT_PADDING = 20;
    const MAX_TEXT_WIDTH = CANVAS_W - TEXT_PADDING * 2;

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       INIT
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    window.onload = function () {
        canvas = new fabric.Canvas('cardCanvas', {
            selection: false,
            allowTouchScrolling: true,
            stopContextMenu: true
        });

        initStep1();
        initDecorations();

        // Constrain objects to canvas on every interaction
        canvas.on('object:moving', constrainToCanvas);
        canvas.on('object:scaling', constrainToCanvas);
        canvas.on('object:modified', constrainToCanvas);
        canvas.on('object:rotating', constrainToCanvas);

        // Touch: prevent page scroll when interacting with canvas
        var canvasEl = document.getElementById('cardCanvas');
        canvasEl.addEventListener('touchstart', function(e) {
            if (canvas.findTarget(e)) {
                e.preventDefault();
            }
        }, { passive: false });
    };

    function constrainToCanvas(e) {
        var obj = e.target;
        if (!obj) return;
        obj.setCoords();
        var bound = obj.getBoundingRect(true);
        var cw = canvas.getWidth();
        var ch = canvas.getHeight();

        // Fully keep object inside canvas
        if (bound.left < 0) obj.left -= bound.left;
        if (bound.top < 0) obj.top -= bound.top;
        if (bound.left + bound.width > cw) obj.left -= (bound.left + bound.width - cw);
        if (bound.top + bound.height > ch) obj.top -= (bound.top + bound.height - ch);

        // Prevent scaling beyond canvas
        obj.setCoords();
        bound = obj.getBoundingRect(true);
        if (bound.width > cw || bound.height > ch) {
            var maxScale = Math.min(cw / (obj.width + obj.padding * 2), ch / (obj.height + obj.padding * 2));
            obj.scaleX = Math.min(obj.scaleX, maxScale);
            obj.scaleY = Math.min(obj.scaleY, maxScale);
        }

        obj.setCoords();
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STEP 1: CHARACTER SELECT
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function initStep1() {
        const grid = document.getElementById('charGrid');
        characters.forEach(char => {
            const div = document.createElement('div');
            div.className = 'char-box';
            div.style.backgroundImage = `url('assets/${char.img}')`;
            div.setAttribute('data-id', char.id);
            div.onclick = () => {
                selectedChar = char;
                document.querySelectorAll('.char-box').forEach(b => b.classList.remove('selected'));
                div.classList.add('selected');
                document.getElementById('toStep2').disabled = false;
            };
            grid.appendChild(div);
        });
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STEP 2: BACKGROUND SELECT
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function initStep2BGs() {
        const container = document.getElementById('bgOptions');
        container.innerHTML = '';

        const bgs = [
            { t: 'img', v: `assets/${selectedChar.bg}` },
            ...solidBGs
        ];

        bgs.forEach((bg, i) => {
            const div = document.createElement('div');
            div.className = 'opt-item';
            if (bg.t === 'col') {
                div.style.backgroundColor = bg.v;
            } else {
                div.style.backgroundImage = `url('${bg.v}')`;
            }
            // Auto-select first (custom bg)
            if (i === 0) {
                div.classList.add('selected');
                applyBG(bg);
            }
            div.onclick = () => {
                container.querySelectorAll('.opt-item').forEach(el => el.classList.remove('selected'));
                div.classList.add('selected');
                applyBG(bg);
            };
            container.appendChild(div);
        });
    }

    function applyBG(bg) {
        if (bg.t === 'col') {
            canvas.setBackgroundImage(null, canvas.renderAll.bind(canvas));
            canvas.setBackgroundColor(bg.v, canvas.renderAll.bind(canvas));
        } else {
            fabric.Image.fromURL(bg.v, (img) => {
                if (!img) return;
                img.set({
                    scaleX: CANVAS_W / img.width,
                    scaleY: CANVAS_H / img.height
                });
                canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
            }, { crossOrigin: 'anonymous' });
        }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STEP 3: TEXT
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function setupText() {
        // Remove previous character image
        if (charImgObj) {
            canvas.remove(charImgObj);
            charImgObj = null;
        }
        // Remove previous text
        if (textObj) {
            canvas.remove(textObj);
            textObj = null;
        }

        // Add character image to canvas
        fabric.Image.fromURL('assets/' + selectedChar.img, function(img) {
            if (!img || !img.width) return;
            var scale = Math.min(140 / img.width, 140 / img.height);
            img.set({
                left: CANVAS_W / 2,
                top: CANVAS_H * 0.3,
                originX: 'center',
                originY: 'center',
                scaleX: scale,
                scaleY: scale,
                cornerColor: 'rgba(255,77,109,0.8)',
                cornerStrokeColor: '#fff',
                cornerSize: 10,
                transparentCorners: false,
                borderColor: 'rgba(255,77,109,0.6)'
            });
            charImgObj = img;
            canvas.add(charImgObj);
            canvas.renderAll();
        }, { crossOrigin: 'anonymous' });

        // Create text (hidden at step 2, shown at step 3)
        textObj = new fabric.Textbox(selectedChar.wish, {
            left: CANVAS_W / 2,
            top: CANVAS_H * 0.7,
            originX: 'center',
            originY: 'center',
            fontSize: 26,
            fontWeight: 'bold',
            fontFamily: 'Roboto',
            textAlign: 'center',
            fill: '#ffffff',
            width: MAX_TEXT_WIDTH,
            splitByGrapheme: false,
            editable: false,
            lockScalingX: false,
            lockScalingY: false,
            cornerColor: 'rgba(255,77,109,0.8)',
            cornerStrokeColor: '#fff',
            cornerSize: 10,
            transparentCorners: false,
            borderColor: 'rgba(255,77,109,0.6)',
            padding: 5,
            shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.4)', blur: 6, offsetX: 1, offsetY: 2 }),
            opacity: 0,
            selectable: false,
            evented: false
        });
        canvas.add(textObj);

        // Set wish input
        document.getElementById('wishInput').value = selectedChar.wish;
        canvas.renderAll();
    }

    function updateText() {
        if (!textObj) return;
        const val = document.getElementById('wishInput').value;
        textObj.set('text', val);

        // Auto-shrink font size if text overflows card height
        let fontSize = 26;
        textObj.set('fontSize', fontSize);
        canvas.renderAll();
        while (textObj.height > CANVAS_H - TEXT_PADDING * 4 && fontSize > 12) {
            fontSize--;
            textObj.set('fontSize', fontSize);
            canvas.renderAll();
        }

        // Re-center vertically
        textObj.set({ top: CANVAS_H * 0.7, originY: 'center' });
        constrainTextToCanvas();
        canvas.renderAll();
    }

    function constrainTextToCanvas() {
        if (!textObj) return;
        const bound = textObj.getBoundingRect();
        if (bound.left < TEXT_PADDING) textObj.left += TEXT_PADDING - bound.left;
        if (bound.top < TEXT_PADDING) textObj.top += TEXT_PADDING - bound.top;
        if (bound.left + bound.width > CANVAS_W - TEXT_PADDING)
            textObj.left -= (bound.left + bound.width) - (CANVAS_W - TEXT_PADDING);
        if (bound.top + bound.height > CANVAS_H - TEXT_PADDING)
            textObj.top -= (bound.top + bound.height) - (CANVAS_H - TEXT_PADDING);
    }

    function setFont(fontName, btn) {
        if (!textObj) return;
        textObj.set('fontFamily', fontName);
        canvas.renderAll();
        document.querySelectorAll('.font-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        // Re-check text fits
        updateText();
    }

    function setTextColor(color, dot) {
        if (!textObj) return;
        textObj.set('fill', color);
        // Adjust shadow for light colors
        if (color === '#ffffff') {
            textObj.set('shadow', new fabric.Shadow({ color: 'rgba(0,0,0,0.5)', blur: 6, offsetX: 1, offsetY: 2 }));
        } else {
            textObj.set('shadow', new fabric.Shadow({ color: 'rgba(0,0,0,0.3)', blur: 4, offsetX: 1, offsetY: 1 }));
        }
        canvas.renderAll();
        document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
        dot.classList.add('selected');
    }

    function resetTextPosition() {
        if (!textObj) return;
        textObj.set({
            left: CANVAS_W / 2,
            top: CANVAS_H * 0.7,
            originX: 'center',
            originY: 'center',
            scaleX: 1,
            scaleY: 1,
            angle: 0
        });
        textObj.setCoords();
        canvas.setActiveObject(textObj);
        canvas.renderAll();
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STEP 4: DECORATIONS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function initDecorations() {
        const container = document.getElementById('decorOptions');
        container.innerHTML = '';
        for (let i = 1; i <= 9; i++) {
            const num = String(i).padStart(2, '0');
            const src = 'assets/d' + num + '.png';
            const div = document.createElement('div');
            div.className = 'opt-item-decor';
            div.style.backgroundImage = "url('" + src + "')";
            div.addEventListener('click', (function(imgSrc) {
                return function() {
                    fabric.Image.fromURL(imgSrc, function(sticker) {
                        if (!sticker || !sticker.width) return;
                        var scale = Math.min(80 / sticker.width, 80 / sticker.height);
                        sticker.set({
                            left: CANVAS_W / 2,
                            top: CANVAS_H / 2,
                            originX: 'center',
                            originY: 'center',
                            scaleX: scale,
                            scaleY: scale,
                            cornerColor: 'rgba(255,77,109,0.8)',
                            cornerStrokeColor: '#fff',
                            cornerSize: 10,
                            transparentCorners: false,
                            borderColor: 'rgba(255,77,109,0.6)'
                        });
                        canvas.add(sticker);
                        canvas.setActiveObject(sticker);
                        canvas.renderAll();
                    }, { crossOrigin: 'anonymous' });
                };
            })(src));
            container.appendChild(div);
        }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       NAVIGATION
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function goToStep(n) {
        // Hide all panels
        document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));
        document.getElementById('step' + n).classList.add('active');

        currentStep = n;
        updateStepIndicator(n);

        // Step-specific logic
        if (n === 1) {
            document.getElementById('previewContainer').classList.remove('visible');
        }

        if (n === 2) {
            document.getElementById('previewContainer').classList.add('visible');
            initStep2BGs();
            setupText();
            // Text completely hidden and non-interactive at step 2
            canvas.discardActiveObject();
            canvas.renderAll();
        }

        if (n === 3) {
            document.getElementById('previewContainer').classList.add('visible');
            if (textObj) {
                textObj.set({ opacity: 1, selectable: true, evented: true });
                canvas.setActiveObject(textObj);
            }
            canvas.renderAll();
        }

        if (n === 4) {
            document.getElementById('previewContainer').classList.add('visible');
            // Deselect text, allow stickers
            canvas.discardActiveObject();
            canvas.renderAll();
        }

        // Scroll to top smoothly
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updateStepIndicator(active) {
        document.querySelectorAll('.step-dot').forEach((dot, i) => {
            const step = i + 1;
            dot.classList.remove('active', 'done');
            if (step === active) dot.classList.add('active');
            else if (step < active) dot.classList.add('done');
        });
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FINALIZE & EXPORT
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function finalize() {
        // Lock all objects
        canvas.forEachObject(obj => {
            obj.selectable = false;
            obj.evented = false;
        });
        canvas.discardActiveObject().renderAll();

        // UI switch
        document.getElementById('controlsPanel').style.display = 'none';
        document.getElementById('stepIndicator').style.display = 'none';
        document.getElementById('finalActions').style.display = 'flex';

        // Scale canvas wrapper to full size
        const wrapper = document.getElementById('canvasWrapper');
        wrapper.style.transform = 'none';
        wrapper.style.margin = '10px 0';
    }

    function downloadCard() {
        const dataURL = canvas.toDataURL({ format: 'png', quality: 1, multiplier: 2 });
        const link = document.createElement('a');
        link.download = 'erotilo-card.png';
        link.href = dataURL;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    async function shareCard() {
        try {
            const dataURL = canvas.toDataURL({ format: 'png', quality: 1, multiplier: 2 });
            const res = await fetch(dataURL);
            const blob = await res.blob();
            const file = new File([blob], 'erotilo-card.png', { type: 'image/png' });

            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                await navigator.share({
                    files: [file],
                    title: 'Erotilo Card ğŸ’Œ',
                    text: 'Î”ÎµÏ‚ Ï„Î¹ ÏƒÎ¿Ï… ÎµÏ„Î¿Î¯Î¼Î±ÏƒÎ±!'
                });
            } else {
                // Fallback: copy image to clipboard
                try {
                    await navigator.clipboard.write([
                        new ClipboardItem({ 'image/png': blob })
                    ]);
                    alert('Î— ÎµÎ¹ÎºÏŒÎ½Î± Î±Î½Ï„Î¹Î³ÏÎ¬Ï†Î·ÎºÎµ ÏƒÏ„Î¿ clipboard!');
                } catch {
                    alert('Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î· Î›Î®ÏˆÎ· Î³Î¹Î± Î½Î± ÎºÎ±Ï„ÎµÎ²Î¬ÏƒÎµÎ¹Ï‚ Ï„Î·Î½ ÎºÎ¬ÏÏ„Î±.');
                }
            }
        } catch (err) {
            alert('Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î· Î›Î®ÏˆÎ· Î³Î¹Î± Î½Î± ÎºÎ±Ï„ÎµÎ²Î¬ÏƒÎµÎ¹Ï‚ Ï„Î·Î½ ÎºÎ¬ÏÏ„Î±.');
        }
    }
</script>
</body>
</html>
